<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ablink SGCarmart Scraper - Market Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f0 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container { max-width: 1800px; margin: 0 auto; }
        
        .header {
            background: linear-gradient(135deg, #4a7c59 0%, #6b9b7a 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }
        
        /* SCRAPE CONTROL PANEL */
        .scrape-panel {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid #4a7c59;
        }
        
        .scrape-title {
            font-size: 20px;
            font-weight: 700;
            color: #4a7c59;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .scrape-button {
            background: linear-gradient(135deg, #7b1fa2 0%, #ab47bc 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 20px;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(123,31,162,0.3);
            transition: all 0.3s;
            display: block;
            margin: 0 auto 20px auto;
        }
        
        .scrape-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(123,31,162,0.4);
        }
        
        .scrape-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .scrape-info {
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        
        .scrape-status {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            margin: 10px;
        }
        
        .status-ready { background: #e8f5e9; color: #2e7d32; }
        .status-scraping { background: #fff3e0; color: #e65100; animation: pulse 1s infinite; }
        .status-error { background: #ffebee; color: #c62828; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .schedule-setting {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .schedule-setting input {
            padding: 8px 15px;
            font-size: 16px;
            border: 2px solid #4a7c59;
            border-radius: 5px;
        }
        
        .schedule-setting button {
            padding: 8px 20px;
            background: #4a7c59;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* HISTORY NAVIGATION */
        .history-nav {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #4a7c59;
        }
        
        .history-title {
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: #4a7c59;
            margin-bottom: 20px;
        }
        
        .history-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .nav-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a7c59 0%, #6b9b7a 100%);
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(74,124,89,0.3);
        }
        
        .nav-btn:hover { 
            transform: scale(1.1); 
            box-shadow: 0 5px 15px rgba(74,124,89,0.5); 
        }
        
        .nav-btn:disabled { 
            background: #ddd; 
            color: #999; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        
        .date-display {
            text-align: center;
            min-width: 250px;
        }
        
        .current-date {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }
        
        .date-label {
            font-size: 13px;
            color: #666;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            font-size: 15px;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4a7c59;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 3px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-primary { background: linear-gradient(135deg, #4a7c59 0%, #6b9b7a 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f57c00 0%, #ffb74d 100%); color: white; }
        
        .file-upload {
            border: 2px dashed #4a7c59;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover { background: #f0f7f0; }
        .file-upload input { display: none; }
        
        .status-msg {
            padding: 8px 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 12px;
        }
        
        .status-success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; }
        .msg-error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin: 20px 0 12px 0;
            padding: 10px 15px;
            background: linear-gradient(135deg, #4a7c59 0%, #6b9b7a 100%);
            color: white;
            border-radius: 8px;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        
        th {
            background: #4a7c59;
            color: white;
            padding: 8px 4px;
            text-align: center;
            font-weight: 700;
            border: 1px solid #3d6b4a;
            font-size: 9px;
            position: sticky;
            top: 0;
        }
        
        th.year-header { background: #5a8c69; }
        th.sub-header { background: #6b9b7a; font-size: 8px; }
        
        td {
            border: 1px solid #e0e0e0;
            padding: 6px 4px;
            text-align: center;
        }
        
        td:first-child {
            text-align: left;
            font-weight: 600;
            color: #333;
            padding-left: 8px;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }
        
        .category-row {
            background: #e8f4e8 !important;
            font-weight: 700 !important;
            color: #333 !important;
            text-align: left !important;
            padding: 8px !important;
            border-top: 2px solid #4a7c59;
        }
        
        .category-row td { background: inherit !important; }
        
        .lowest { color: #2e7d32; font-weight: 700; }
        .average { color: #1565c0; font-weight: 600; }
        .units-cell { color: #666; }
        .total-col { background: #fff8e1; font-weight: 700; color: #e65100; }
        .diff-pos { background: #e8f5e9; color: #2e7d32; font-weight: 700; }
        .diff-neg { background: #ffebee; color: #c62828; font-weight: 700; }
        .empty { color: #bbb; }
        
        .loading { text-align: center; padding: 30px; color: #666; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a7c59;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 11px;
            margin-top: 20px;
        }
        
        .pricelist-info { background: #e3f2fd; padding: 12px; border-radius: 8px; margin: 8px 0; font-size: 12px; }
        .pricelist-info h3 { color: #1565c0; margin-bottom: 8px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöõ Ablink SGCarmart Scraper</h1>
            <p>Real-time Market Data from SGCarmart.com | By Oneiros Indonesia</p>
        </div>
        
        <!-- SCRAPING CONTROL PANEL -->
        <div class="scrape-panel">
            <div class="scrape-title">üîÑ REAL-TIME SCRAPING FROM SGCARMART.COM</div>
            
            <button class="scrape-button" id="scrapeBtn" onclick="startScraping()">
                üîÑ REFRESH DATA
            </button>
            
            <div class="scrape-info">
                <span class="scrape-status" id="statusIndicator">Ready</span>
                <div style="margin-top: 10px;">
                    Last scrape: <strong id="lastScrape">-</strong>
                </div>
            </div>
            
            <div class="schedule-setting">
                <span style="font-weight: 600;">Auto Scrape Daily at:</span>
                <input type="time" id="scheduleTime" value="09:00" />
                <button onclick="updateSchedule()">Update Schedule</button>
                <span id="scheduleStatus" style="color: #2e7d32; font-weight: 600;">Current: 09:00 AM</span>
            </div>
        </div>
        
        <!-- HISTORY NAVIGATION -->
        <div class="history-nav">
            <div class="history-title">üìÖ DATA HISTORY NAVIGATION</div>
            <div class="history-controls">
                <button class="nav-btn" id="prevBtn" onclick="loadPreviousDate()" title="Previous Day">‚óÄ</button>
                
                <div class="date-display">
                    <div class="current-date" id="currentDate">Loading...</div>
                    <div class="date-label" id="dateLabel">Loading data...</div>
                    <div style="font-size: 11px; color: #888; margin-top: 5px;">
                        Use ‚Üê ‚Üí arrow keys | History: <span id="historyCount">0</span> days
                    </div>
                </div>
                
                <button class="nav-btn" id="nextBtn" onclick="loadNextDate()" title="Next Day">‚ñ∂</button>
            </div>
        </div>
        
        <div class="controls">
            <!-- Upload Pricelist -->
            <div class="card">
                <h2>üì§ Upload Pricelist</h2>
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 30px;">üìÑ</div>
                    <p style="margin: 5px 0;">Click to upload</p>
                    <p style="font-size: 10px; color: #888;">.xlsx, .xls, .csv</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="uploadFile(this)">
                </div>
                <div id="uploadStatus"></div>
                <button class="btn btn-danger" onclick="clearPricelist()" style="margin-top: 10px;">Clear Pricelist</button>
                <div id="pricelistInfo" style="margin-top: 10px;"></div>
            </div>
            
            <!-- Export -->
            <div class="card">
                <h2>üíæ Export Current Data</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button class="btn btn-primary" onclick="exportData('csv')">üìÑ CSV</button>
                    <button class="btn btn-info" onclick="exportData('excel')">üìä Excel</button>
                    <button class="btn btn-warning" onclick="exportData('pdf')">üìï PDF</button>
                </div>
                <p style="margin-top: 10px; font-size: 11px; color: #666;">
                    Exports depreciation & units sold data
                </p>
            </div>
            
            <!-- Data Info -->
            <div class="card">
                <h2>üìä Data Information</h2>
                <div style="font-size: 12px;">
                    <div style="margin: 8px 0;">
                        <strong>Source:</strong> SGCarmart.com
                    </div>
                    <div style="margin: 8px 0;">
                        <strong>Categories:</strong> 10FT, 14FT, VAN Diesel/Petrol
                    </div>
                    <div style="margin: 8px 0;">
                        <strong>Data:</strong> Lowest, Average, Units
                    </div>
                </div>
            </div>
        </div>
        
        <!-- COMPARISON SECTION - Shows when pricelist uploaded -->
        <div id="comparisonSection" style="display: none; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0;">
                <h2 style="margin: 0; font-size: 18px;">üìä PRICE COMPARISON: Your Pricelist vs SGCarmart</h2>
            </div>
            <div style="background: white; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div style="background: #e3f2fd; padding: 10px 20px; border-radius: 8px; border-left: 4px solid #1565c0;">
                        <strong style="color: #1565c0;">üîµ Your Price (Ablink)</strong> - From uploaded pricelist
                    </div>
                    <div style="background: #e8f5e9; padding: 10px 20px; border-radius: 8px; border-left: 4px solid #2e7d32;">
                        <strong style="color: #2e7d32;">üü¢ Cheaper than you</strong> - SGCarmart vehicles with lower depreciation
                    </div>
                    <div style="background: #ffebee; padding: 10px 20px; border-radius: 8px; border-left: 4px solid #c62828;">
                        <strong style="color: #c62828;">üî¥ More expensive</strong> - SGCarmart vehicles with higher depreciation
                    </div>
                </div>
                <div class="table-container" style="margin: 0; box-shadow: none;" id="comparisonTable"></div>
            </div>
        </div>
        
        <!-- LEGEND -->
        <div style="background: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <strong>üìã Data Legend:</strong>
            <span style="margin-left: 15px; color: #2e7d32;">‚óè Lowest = Cheapest price on SGCarmart</span>
            <span style="margin-left: 15px; color: #1565c0;">‚óè Average = Average price on SGCarmart</span>
            <span style="margin-left: 15px; color: #e65100;">‚óè Total Units = Number of vehicles available</span>
            <span style="margin-left: 15px; color: #2e7d32;">‚óè +Diff = More units than yesterday</span>
            <span style="margin-left: 15px; color: #c62828;">‚óè -Diff = Less units than yesterday</span>
        </div>
        
        <!-- DEPRECIATION TABLE -->
        <div class="section-title">
            DEPRECIATION / UNITS (Lowest + Average per Year) - Data from SGCarmart.com
        </div>
        
        <div class="table-container" id="depreciationTable">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading depreciation data...</p>
            </div>
        </div>
        
        <!-- UNITS SOLD TABLE -->
        <div class="section-title">
            NUMBER OF UNITS SOLD LAST 60 DAYS - Data from SGCarmart.com
        </div>
        
        <div style="background: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; font-size: 12px; color: #666;">
            <strong>üìà Units Analysis:</strong> Shows how many vehicles of each model were listed on SGCarmart in the last 60 days, grouped by registration year. Higher numbers indicate more popular/available models.
        </div>
        
        <div class="table-container" id="unitsSoldTable">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading units sold data...</p>
            </div>
        </div>
        
        <div class="footer">
            <strong>Ablink SGCarmart Scraper</strong> | Developed by <strong>Oneiros Indonesia</strong><br>
            Real-time market data from SGCarmart.com
        </div>
    </div>
    
    <script>
        const YEARS = ['2026', '2025', '2024', '2023', '2022', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014'];
        const CATEGORY_COLORS = {
            '10FT DIESEL': '#E8F4E8',
            '14FT DIESEL': '#E8F0F8',
            'VAN DIESEL (GOODS VAN)': '#FFF8E8',
            'VAN PETROL (GOODS VAN)': '#F8E8F0'
        };
        
        let currentDate = null;
        let previousDate = null;
        let nextDate = null;
        
        window.onload = function() {
            console.log('=== PAGE LOADED ===');
            console.log('Template version: 2026-01-29-v2');
            loadLatestData();
            loadHistory();
            loadPricelistInfo();
            updateStatus();
            setInterval(updateStatus, 30000);
        };
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') loadPreviousDate();
            else if (e.key === 'ArrowRight') loadNextDate();
        });
        
        function loadLatestData() {
            fetch('/api/data/latest')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentDate = data.date;
                        previousDate = data.previous_date;
                        nextDate = data.next_date;
                        updateDateDisplay();
                        renderDepreciationTable(data.data);
                        renderUnitsSoldTable(data.data);
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    document.getElementById('depreciationTable').innerHTML = '<p class="msg-error">Error loading data</p>';
                });
        }
        
        function loadDataByDate(date) {
            fetch(`/api/data/${date}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentDate = data.date;
                        previousDate = data.previous_date;
                        nextDate = data.next_date;
                        updateDateDisplay();
                        renderDepreciationTable(data.data);
                        renderUnitsSoldTable(data.data);
                    }
                });
        }
        
        function loadPreviousDate() {
            if (previousDate) loadDataByDate(previousDate);
        }
        
        function loadNextDate() {
            if (nextDate) loadDataByDate(nextDate);
        }
        
        function updateDateDisplay() {
            document.getElementById('currentDate').textContent = formatDate(currentDate);
            document.getElementById('prevBtn').disabled = !previousDate;
            document.getElementById('nextBtn').disabled = !nextDate;
            document.getElementById('dateLabel').textContent = nextDate ? 'Historical Data' : 'Latest Data';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'No Data';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' 
            });
        }
        
        function loadHistory() {
            fetch('/api/history')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('historyCount').textContent = data.total;
                    }
                });
        }
        
        function updateStatus() {
            fetch('/api/status')
                .then(res => res.json())
                .then(data => {
                    const indicator = document.getElementById('statusIndicator');
                    const scrapeBtn = document.getElementById('scrapeBtn');
                    
                    if (data.is_scraping) {
                        indicator.className = 'scrape-status status-scraping';
                        indicator.textContent = 'Loading...';
                        scrapeBtn.disabled = true;
                        scrapeBtn.textContent = '‚è≥ LOADING...';
                    } else {
                        indicator.className = 'scrape-status status-ready';
                        indicator.textContent = 'Ready';
                        scrapeBtn.disabled = false;
                        scrapeBtn.textContent = 'üîÑ REFRESH DATA';
                    }
                    
                    if (data.last_scrape) {
                        document.getElementById('lastScrape').textContent = data.last_scrape;
                    }
                });
        }
        
        function startScraping() {
            if (!confirm('Refresh data from SGCarmart?\n\nThis will load the latest market data.')) return;
            
            const indicator = document.getElementById('statusIndicator');
            const scrapeBtn = document.getElementById('scrapeBtn');
            
            indicator.className = 'scrape-status status-scraping';
            indicator.textContent = 'Loading...';
            scrapeBtn.disabled = true;
            scrapeBtn.textContent = '‚è≥ LOADING...';
            
            fetch('/api/scrape', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const source = data.source || 'SGCarmart';
                        alert(`‚úì Data Loaded!\n\n${data.vehicles_count} vehicles\nSource: ${source}\nDate: ${data.date}`);
                        loadLatestData();
                        loadHistory();
                        loadComparison();
                    } else {
                        alert('‚úó Failed to load data\n\n' + (data.error || 'Unknown error'));
                    }
                    updateStatus();
                })
                .catch(err => {
                    alert('‚úó Network Error: ' + err);
                    updateStatus();
                })
                .finally(() => {
                    scrapeBtn.disabled = false;
                    scrapeBtn.textContent = 'üîÑ REFRESH DATA';
                });
        }
        
        function updateSchedule() {
            const time = document.getElementById('scheduleTime').value;
            alert(`Schedule will be updated to ${time} on next server restart.\n\nNote: This requires server restart to take effect.`);
            document.getElementById('scheduleStatus').textContent = `Pending: ${time}`;
        }
        
        function loadPricelistInfo() {
            fetch('/api/pricelist')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.data) {
                        document.getElementById('pricelistInfo').innerHTML = `
                            <div class="pricelist-info">
                                <h3>‚úì Pricelist Loaded</h3>
                                <p>${data.data.vehicles.length} vehicles from Ablink</p>
                            </div>
                        `;
                        // Load comparison
                        loadComparison();
                    } else {
                        document.getElementById('pricelistInfo').innerHTML = `
                            <p style="font-size: 11px; color: #888;">No pricelist uploaded</p>
                        `;
                        document.getElementById('comparisonSection').style.display = 'none';
                    }
                });
        }
        
        function loadComparison() {
            console.log('Loading comparison...');
            fetch('/api/comparison')
                .then(res => res.json())
                .then(data => {
                    console.log('Comparison data:', data);
                    if (data.success && data.data && data.data.length > 0) {
                        console.log('Showing comparison section with', data.data.length, 'items');
                        document.getElementById('comparisonSection').style.display = 'block';
                        renderComparisonTable(data.data);
                    } else {
                        console.log('No comparison data to show');
                        document.getElementById('comparisonSection').style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Comparison error:', err);
                });
        }
        
        function renderComparisonTable(data) {
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #1565c0; color: white;">
                            <th style="padding: 12px; text-align: left;">Vehicle</th>
                            <th style="padding: 12px;">Year</th>
                            <th style="padding: 12px; background: #0d47a1;">Your Depreciation<br>(Ablink)</th>
                            <th style="padding: 12px; background: #2e7d32;">SGCarmart<br>Lowest</th>
                            <th style="padding: 12px; background: #1565c0;">SGCarmart<br>Average</th>
                            <th style="padding: 12px; background: #2e7d32;">Cheaper<br>than you</th>
                            <th style="padding: 12px; background: #c62828;">More<br>Expensive</th>
                            <th style="padding: 12px;">Total on<br>SGCarmart</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach((item, idx) => {
                const rowBg = idx % 2 === 0 ? '#f8f9fa' : 'white';
                const priceDiff = item.our_depreciation - item.sg_lowest;
                const diffColor = priceDiff > 0 ? '#c62828' : '#2e7d32';
                const diffText = priceDiff > 0 ? `+$${priceDiff.toLocaleString()} higher` : `$${Math.abs(priceDiff).toLocaleString()} lower`;
                
                html += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 10px; font-weight: 600;">${item.vehicle}</td>
                        <td style="padding: 10px; text-align: center;">${item.registered_year}</td>
                        <td style="padding: 10px; text-align: center; background: #e3f2fd; font-weight: 700; color: #0d47a1;">
                            $${item.our_depreciation.toLocaleString()}/yr
                        </td>
                        <td style="padding: 10px; text-align: center; color: #2e7d32; font-weight: 700;">
                            $${item.sg_lowest.toLocaleString()}/yr
                        </td>
                        <td style="padding: 10px; text-align: center; color: #1565c0; font-weight: 600;">
                            $${item.sg_average.toLocaleString()}/yr
                        </td>
                        <td style="padding: 10px; text-align: center; background: #e8f5e9; color: #2e7d32; font-weight: 700;">
                            ${item.cheaper_count} vehicles
                        </td>
                        <td style="padding: 10px; text-align: center; background: #ffebee; color: #c62828; font-weight: 700;">
                            ${item.expensive_count} vehicles
                        </td>
                        <td style="padding: 10px; text-align: center; font-weight: 600;">
                            ${item.sg_units} units
                        </td>
                    </tr>
                    <tr style="background: #fff8e1; border-bottom: 2px solid #e0e0e0;">
                        <td colspan="8" style="padding: 8px 10px; font-size: 11px;">
                            <strong>Analysis:</strong> Your price is <span style="color: ${diffColor}; font-weight: 700;">${diffText}</span> than SGCarmart lowest.
                            ${item.cheaper_count > 0 ? `<span style="color: #c62828;">‚ö† ${item.cheaper_count} competitors are cheaper than you.</span>` : '<span style="color: #2e7d32;">‚úì You have competitive pricing!</span>'}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('comparisonTable').innerHTML = html;
        }
        
        function renderDepreciationTable(data) {
            let html = `<table><thead><tr><th rowspan="2" style="width: 130px;">Vehicle</th>`;
            
            YEARS.forEach(year => html += `<th colspan="2" class="year-header">${year}</th>`);
            html += `<th rowspan="2">TOTAL<br>UNITS</th><th rowspan="2">Previous</th><th rowspan="2">DIFF</th></tr><tr>`;
            YEARS.forEach(() => html += `<th class="sub-header">Low</th><th class="sub-header">Avg</th>`);
            html += `</tr></thead><tbody>`;
            
            let currentCategory = '';
            data.vehicles.forEach(vehicle => {
                if (vehicle.category !== currentCategory) {
                    currentCategory = vehicle.category;
                    const bgColor = CATEGORY_COLORS[currentCategory] || '#f5f5f5';
                    const colspan = 3 + (YEARS.length * 2);
                    html += `<tr class="category-row"><td colspan="${colspan}" style="background: ${bgColor};">${currentCategory}</td></tr>`;
                }
                
                html += `<tr><td>${vehicle.vehicle}</td>`;
                
                YEARS.forEach(year => {
                    const yearData = vehicle.years[year] || {};
                    html += (yearData.lowest || 0) > 0 ? `<td class="lowest">$${yearData.lowest.toLocaleString()}</td>` : '<td class="empty">-</td>';
                    html += (yearData.average || 0) > 0 ? `<td class="average">$${yearData.average.toLocaleString()}</td>` : '<td class="empty">-</td>';
                });
                
                html += `<td class="total-col">${vehicle.total_units}</td>`;
                html += `<td>${vehicle.previous || vehicle.total_units}</td>`;
                
                const diff = vehicle.diff || 0;
                html += diff > 0 ? `<td class="diff-pos">+${diff}</td>` : diff < 0 ? `<td class="diff-neg">${diff}</td>` : `<td>0</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('depreciationTable').innerHTML = html;
        }
        
        function renderUnitsSoldTable(data) {
            let html = `<table><thead><tr><th style="width: 130px;">Vehicle</th>`;
            YEARS.forEach(year => html += `<th>${year}</th>`);
            html += `<th>TOTAL<br>UNITS</th><th>Last 120<br>Days</th></tr></thead><tbody>`;
            
            let currentCategory = '';
            data.vehicles.forEach(vehicle => {
                if (vehicle.category !== currentCategory) {
                    currentCategory = vehicle.category;
                    const bgColor = CATEGORY_COLORS[currentCategory] || '#f5f5f5';
                    const colspan = 3 + YEARS.length;
                    html += `<tr class="category-row"><td colspan="${colspan}" style="background: ${bgColor};">${currentCategory}</td></tr>`;
                }
                
                html += `<tr><td>${vehicle.vehicle}</td>`;
                YEARS.forEach(year => {
                    const units = vehicle.years[year]?.units || 0;
                    html += units > 0 ? `<td class="units-cell">${units}</td>` : '<td class="empty">0</td>';
                });
                html += `<td class="total-col">${vehicle.total_units}</td><td>${vehicle.previous || vehicle.total_units}</td></tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('unitsSoldTable').innerHTML = html;
        }
        
        function uploadFile(input) {
            if (input.files.length === 0) return;
            
            const formData = new FormData();
            formData.append('file', input.files[0]);
            document.getElementById('uploadStatus').innerHTML = '<div class="status-msg">Uploading...</div>';
            
            fetch('/api/upload-pricelist', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('uploadStatus').innerHTML = data.success 
                        ? `<div class="status-success">${data.message}</div>` 
                        : `<div class="msg-error">${data.error}</div>`;
                    if (data.success) loadPricelistInfo();
                });
        }
        
        function clearPricelist() {
            if (!confirm('Clear pricelist?')) return;
            fetch('/api/clear-pricelist', { method: 'POST' })
                .then(() => {
                    document.getElementById('uploadStatus').innerHTML = '<div class="status-success">Cleared</div>';
                    loadPricelistInfo();
                });
        }
        
        function exportData(format) {
            const date = currentDate || 'latest';
            if (format === 'pdf') {
                window.open(`/api/export/${date}/${format}`, '_blank');
            } else {
                window.location.href = `/api/export/${date}/${format}`;
            }
        }
    </script>
</body>
</html>
